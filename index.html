import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, 
  arrayUnion, increment 
} from 'firebase/firestore';
import { 
  Zap, ShoppingCart, Handshake
} from 'lucide-react';

// --- FIREBASE SETUP ---
const getFirebaseConfig = () => {
  try {
    if (typeof __firebase_config !== 'undefined') {
      return JSON.parse(__firebase_config);
    }
  } catch (e) {
    console.warn("Sistem config bulunamadƒ±, fallback kullanƒ±lƒ±yor.");
  }
  return {
    apiKey: "AIzaSyCbolraCD1nrOqcIE5GHPAaX9SRhHQXYIY",
    authDomain: "videoanlyze.firebaseapp.com",
    projectId: "videoanlyze",
    storageBucket: "videoanlyze.firebasestorage.app",
    messagingSenderId: "1053069335615",
    appId: "1:1053069335615:web:5dbf8f2345a5bf18b1ac8a",
    measurementId: "G-TLEWYXX05H"
  };
};

const app = initializeApp(getFirebaseConfig());
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'videoanlyze';

// --- GAME CONSTANTS & DATA ---
const MAP_SIZE = 32;
const COUNTRIES = [
  { code: 'TR', name: 'T√ºrkiye', flag: 'üáπüá∑', color: 'bg-red-600' },
  { code: 'US', name: 'ABD', flag: 'üá∫üá∏', color: 'bg-blue-600' },
  { code: 'RU', name: 'Rusya', flag: 'üá∑üá∫', color: 'bg-red-800' },
  { code: 'CN', name: '√áin', flag: 'üá®üá≥', color: 'bg-yellow-600' },
  { code: 'DE', name: 'Almanya', flag: 'üá©üá™', color: 'bg-gray-800' },
  { code: 'GB', name: 'ƒ∞ngiltere', flag: 'üá¨üáß', color: 'bg-blue-800' },
  { code: 'FR', name: 'Fransa', flag: 'üá´üá∑', color: 'bg-blue-500' },
  { code: 'JP', name: 'Japonya', flag: 'üáØüáµ', color: 'bg-red-400' },
  { code: 'KR', name: 'G√ºney Kore', flag: 'üá∞üá∑', color: 'bg-blue-400' },
  { code: 'BR', name: 'Brezilya', flag: 'üáßüá∑', color: 'bg-green-600' },
];

const BUILDINGS = {
  HQ: { id: 'HQ', name: 'Karargah', icon: 'üèõÔ∏è', cost: { oil: 0, wheat: 0, dollar: 0 } },
  BARRACKS: { id: 'BARRACKS', name: 'Kƒ±≈üla', icon: 'üè†', cost: { oil: 200, wheat: 100, dollar: 300 } },
  TOWER: { id: 'TOWER', name: 'Savunma Kulesi', icon: 'üóº', cost: { oil: 150, wheat: 50, dollar: 200 }, range: 3, damage: 20 },
  RADAR: { id: 'RADAR', name: 'Radar', icon: 'üì°', cost: { oil: 100, wheat: 0, dollar: 500 }, range: 8 },
  HOSPITAL: { id: 'HOSPITAL', name: 'Hastane', icon: 'üè•', cost: { oil: 100, wheat: 300, dollar: 200 }, range: 2 },
};

const UNITS = {
  INFANTRY: { id: 'INFANTRY', name: 'Piyade', icon: 'üî´', cost: { oil: 50, wheat: 50, dollar: 50 }, hp: 100, damage: 15, range: 2, moveCost: 10, ammoCost: 10 },
  HEAVY: { id: 'HEAVY', name: 'Aƒüƒ±r Piyade', icon: 'üí™', cost: { oil: 150, wheat: 100, dollar: 100 }, hp: 250, damage: 25, range: 1, moveCost: 20, ammoCost: 20 },
  SNIPER: { id: 'SNIPER', name: 'Keskin Ni≈üancƒ±', icon: 'üéØ', cost: { oil: 50, wheat: 100, dollar: 200 }, hp: 60, damage: 60, range: 5, moveCost: 15, ammoCost: 30 },
  SCOUT: { id: 'SCOUT', name: 'Ke≈üif√ßi', icon: 'üèÉ', cost: { oil: 100, wheat: 50, dollar: 50 }, hp: 80, damage: 5, range: 3, moveCost: 5, ammoCost: 5 },
};

const RESOURCES = {
  OIL: { id: 'oil', name: 'Petrol', icon: 'üõ¢Ô∏è', color: 'text-gray-900' },
  WHEAT: { id: 'wheat', name: 'Buƒüday', icon: 'üåæ', color: 'text-yellow-600' },
  DOLLAR: { id: 'dollar', name: 'Dolar', icon: 'üíµ', color: 'text-green-600' },
  AMMO: { id: 'ammo', name: 'M√ºhimmat', icon: 'üîπ', color: 'text-blue-600' },
  MOVE: { id: 'move', name: 'Hareket', icon: 'üëü', color: 'text-orange-600' },
};

// --- HELPER FUNCTIONS ---
const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();
const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// --- MAIN COMPONENT ---
export default function TaktikKomuta() {
  const [user, setUser] = useState(null);
  const [gameState, setGameState] = useState('menu'); // menu, lobby, game
  const [gameCode, setGameCode] = useState('');
  const [gameData, setGameData] = useState(null);
  const [myPlayer, setMyPlayer] = useState(null);
  const [selectedCountry, setSelectedCountry] = useState(COUNTRIES[0]);
  const [selectedTile, setSelectedTile] = useState(null);
  const [notification, setNotification] = useState(null);
  const [marketOffers, setMarketOffers] = useState([]);
  const [loading, setLoading] = useState(false);

  // Refs for intervals to access latest state without resetting interval
  const gameDataRef = useRef(null);
  const myPlayerRef = useRef(null);
  const userRef = useRef(null);

  useEffect(() => {
    gameDataRef.current = gameData;
  }, [gameData]);

  useEffect(() => {
    myPlayerRef.current = myPlayer;
  }, [myPlayer]);

  useEffect(() => {
    userRef.current = user;
  }, [user]);

  // Auth Handling
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  // Game Data Listener
  useEffect(() => {
    if (!user || !gameCode || gameState === 'menu') return;

    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`);
    const unsubscribe = onSnapshot(gameRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setGameData(data);
        if (data.players && data.players[user.uid]) {
          setMyPlayer(data.players[user.uid]);
        }
        if (data.market) setMarketOffers(data.market);
      } else {
        showNotification("Oyun bulunamadƒ± veya sonlandƒ±.");
        setGameState('menu');
      }
    });
    return () => unsubscribe();
  }, [user, gameCode, gameState]);

  // Resource Production Loop
  // Fixed: Uses refs to avoid resetting the interval on every state change
  useEffect(() => {
    if (gameState !== 'game') return;

    const interval = setInterval(async () => {
      const gData = gameDataRef.current;
      const mPlayer = myPlayerRef.current;
      const cUser = userRef.current;

      if (!gData || !mPlayer || !cUser) return;

      let oilIncome = 0;
      let wheatIncome = 0;
      let dollarIncome = 0;

      // Scan map for owned mines
      gData.map.forEach(row => {
        row.forEach(tile => {
            if (tile.owner === cUser.uid && (tile.structureType === 'MINE' || tile.structureType === 'MINE_WILD')) {
                // If the player captured a MINE_WILD, we consider it a MINE for production
                if (tile.resourceType === 'oil') oilIncome += tile.production || 10;
                if (tile.resourceType === 'wheat') wheatIncome += tile.production || 10;
                if (tile.resourceType === 'dollar') dollarIncome += tile.production || 10;
            }
        });
      });

      // Update Firestore only if there is income
      if (oilIncome > 0 || wheatIncome > 0 || dollarIncome > 0) {
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`);
        try {
            await updateDoc(gameRef, {
                [`players.${cUser.uid}.resources.oil`]: increment(oilIncome),
                [`players.${cUser.uid}.resources.wheat`]: increment(wheatIncome),
                [`players.${cUser.uid}.resources.dollar`]: increment(dollarIncome)
            });
            // Optional: Show small +income floating text (not implemented for simplicity)
        } catch (e) {
            console.error("Income sync error:", e);
        }
      }
    }, 10000); // Every 10 seconds

    return () => clearInterval(interval);
  }, [gameState, gameCode]); // Only restart if game state changes

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  // --- ACTIONS ---

  const createGame = async () => {
    if (!user) return;
    setLoading(true);
    const code = generateCode();
    
    // Generate Map
    const newMap = [];
    for (let y = 0; y < MAP_SIZE; y++) {
      const row = [];
      for (let x = 0; x < MAP_SIZE; x++) {
        let type = 'ground';
        let resource = null;
        let production = 0;
        
        // Random Resources (10% chance)
        if (Math.random() < 0.10) {
            const rRand = Math.random();
            if (rRand < 0.33) { resource = 'oil'; production = getRandomInt(500, 2000); }
            else if (rRand < 0.66) { resource = 'wheat'; production = getRandomInt(500, 2000); }
            else { resource = 'dollar'; production = getRandomInt(500, 2000); }
        }
        
        row.push({
            x, y, type, 
            resourceType: resource, 
            maxReserve: production * 10,
            production: Math.floor(production / 50),
            structureType: resource ? 'MINE_WILD' : null,
            unit: null,
            owner: null
        });
      }
      newMap.push(row);
    }

    const initialData = {
      code,
      host: user.uid,
      status: 'lobby',
      createdAt: Date.now(),
      players: {
        [user.uid]: {
            id: user.uid,
            name: `Komutan ${user.uid.slice(0,4)}`,
            country: selectedCountry,
            ready: false,
            resources: { oil: 500, wheat: 500, dollar: 500, ammo: 50, move: 50 },
            diplomacy: {}
        }
      },
      map: newMap,
      market: []
    };

    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${code}`), initialData);
      setGameCode(code);
      setGameState('lobby');
    } catch (error) {
      console.error(error);
      showNotification("Oyun olu≈üturulamadƒ±. ƒ∞zinleri kontrol edin.");
    }
    setLoading(false);
  };

  const joinGame = async (codeInput) => {
    if (!user || !codeInput) return;
    setLoading(true);
    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `game_${codeInput}`);
    try {
        const snap = await getDoc(gameRef);
        if (snap.exists()) {
            const data = snap.data();
            if (data.status !== 'lobby') {
                showNotification("Oyun √ßoktan ba≈üladƒ±.");
                setLoading(false);
                return;
            }
            if (Object.keys(data.players).length >= 10) {
                showNotification("Oda dolu.");
                setLoading(false);
                return;
            }

            // Check if already joined
            if (!data.players[user.uid]) {
                await updateDoc(gameRef, {
                    [`players.${user.uid}`]: {
                        id: user.uid,
                        name: `Komutan ${user.uid.slice(0,4)}`,
                        country: selectedCountry,
                        ready: false,
                        resources: { oil: 500, wheat: 500, dollar: 500, ammo: 50, move: 50 },
                        diplomacy: {}
                    }
                });
            }
            setGameCode(codeInput);
            setGameState('lobby');
        } else {
            showNotification("Oyun kodu ge√ßersiz.");
        }
    } catch (e) {
        console.error(e);
        showNotification("Hata olu≈ütu.");
    }
    setLoading(false);
  };

  const startGame = async () => {
    if (!gameData || gameData.host !== user.uid) return;
    
    // Assign HQs randomly
    const updatedMap = [...gameData.map];
    const playerIds = Object.keys(gameData.players);
    const positions = [];
    
    playerIds.forEach(pid => {
        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 100) {
            attempts++;
            const rx = getRandomInt(2, MAP_SIZE - 3);
            const ry = getRandomInt(2, MAP_SIZE - 3);
            const tooClose = positions.some(p => Math.abs(p.x - rx) < 5 && Math.abs(p.y - ry) < 5);
            if (!tooClose && !updatedMap[ry][rx].resourceType) {
                updatedMap[ry][rx].structureType = 'HQ';
                updatedMap[ry][rx].owner = pid;
                updatedMap[ry][rx].hp = 1000;
                positions.push({x: rx, y: ry});
                placed = true;
            }
        }
    });

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
        status: 'game',
        map: updatedMap
    });
  };

  // --- GAMEPLAY ACTIONS ---

  const buyResource = async (type) => {
    if (!myPlayer) return;

    const currentOil = myPlayer.resources.oil;
    const currentWheat = myPlayer.resources.wheat;
    const currentDollar = myPlayer.resources.dollar;

    let updates = {};

    if (type === 'AMMO') {
        // Cost: 50 Wheat + 50 Oil
        if (currentWheat >= 50 && currentOil >= 50) {
            updates = {
                [`players.${user.uid}.resources.wheat`]: increment(-50),
                [`players.${user.uid}.resources.oil`]: increment(-50),
                [`players.${user.uid}.resources.ammo`]: increment(50)
            };
        } else { showNotification("Yetersiz Petrol veya Buƒüday!"); return; }
    } else if (type === 'MOVE') {
        // Cost: 50 Oil + 50 Dollar
        if (currentOil >= 50 && currentDollar >= 50) {
             updates = {
                [`players.${user.uid}.resources.oil`]: increment(-50),
                [`players.${user.uid}.resources.dollar`]: increment(-50),
                [`players.${user.uid}.resources.move`]: increment(50)
            };
        } else { showNotification("Yetersiz Petrol veya Dolar!"); return; }
    }

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), updates);
  };

  const handleTileClick = async (x, y) => {
    if (!gameData || gameState !== 'game') return;
    const clickedTile = gameData.map[y][x];

    // MOVEMENT & ATTACK LOGIC
    if (selectedTile && selectedTile.unit && selectedTile.owner === user.uid) {
        // If clicking same tile, deselect
        if (selectedTile.x === x && selectedTile.y === y) {
            setSelectedTile(null);
            return;
        }

        const dx = Math.abs(selectedTile.x - x);
        const dy = Math.abs(selectedTile.y - y);
        const dist = Math.max(dx, dy); // Chebyshev distance
        
        // --- MOVE ---
        // Can move if empty OR if it's a wild mine (to capture it)
        const isStructureBlocking = clickedTile.structureType && clickedTile.structureType !== 'MINE_WILD' && clickedTile.structureType !== 'MINE';
        const isUnitBlocking = clickedTile.unit;
        
        // Simplified: Can only move to empty ground or own structures/mines or wild mines
        const canEnter = !clickedTile.unit && (!clickedTile.structureType || clickedTile.structureType === 'MINE_WILD' || (clickedTile.structureType === 'MINE' && clickedTile.owner === user.uid));

        if (canEnter && dist <= 1) { 
             const unitType = UNITS[selectedTile.unit.type];
             if (myPlayer.resources.move >= unitType.moveCost) {
                 const updatedMap = JSON.parse(JSON.stringify(gameData.map)); // Deep copy
                 
                 // Move unit data
                 updatedMap[y][x].unit = { ...selectedTile.unit };
                 updatedMap[y][x].owner = user.uid; // Unit presence claims land
                 
                 // Clear old
                 updatedMap[selectedTile.y][selectedTile.x].unit = null;

                 // Mine Capture Logic
                 if (updatedMap[y][x].structureType === 'MINE_WILD') {
                     updatedMap[y][x].structureType = 'MINE';
                     updatedMap[y][x].owner = user.uid;
                     showNotification("Maden ele ge√ßirildi!");
                 }

                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
                     map: updatedMap,
                     [`players.${user.uid}.resources.move`]: increment(-unitType.moveCost)
                 });
                 setSelectedTile(null);
                 return;
             } else {
                 showNotification("Yetersiz Hareket Puanƒ±!");
             }
        }

        // --- ATTACK ---
        if ((clickedTile.unit || (clickedTile.structureType && clickedTile.owner)) && clickedTile.owner !== user.uid) {
             const pact = myPlayer.diplomacy?.[clickedTile.owner];
             if (pact && pact > Date.now()) {
                 showNotification("Saldƒ±rmazlƒ±k paktƒ± var!");
                 return;
             }

             const unitType = UNITS[selectedTile.unit.type];
             if (dist <= unitType.range) {
                 if (myPlayer.resources.ammo >= unitType.ammoCost) {
                    const updatedMap = JSON.parse(JSON.stringify(gameData.map));
                    const target = updatedMap[y][x];
                    
                    const damage = unitType.damage;
                    
                    // Attack Unit
                    if (target.unit) {
                        target.unit.hp -= damage;
                        if (target.unit.hp <= 0) {
                            target.unit = null;
                            showNotification("D√º≈üman birimi yok edildi!");
                        }
                    } 
                    // Attack Building
                    else if (target.structureType) {
                        target.hp = (target.hp || 500) - damage;
                        if (target.hp <= 0) {
                            target.structureType = null;
                            target.owner = null;
                            showNotification("Bina yƒ±kƒ±ldƒ±!");
                        }
                    }

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
                         map: updatedMap,
                        [`players.${user.uid}.resources.ammo`]: increment(-unitType.ammoCost)
                    });
                    setSelectedTile(null); 
                 } else {
                     showNotification("Yetersiz M√ºhimmat!");
                 }
                 return;
             } else {
                 showNotification("Menzil dƒ±≈üƒ±!");
             }
        }
    }

    setSelectedTile(clickedTile);
  };

  const buildStructure = async (buildingKey) => {
    if (!selectedTile || !myPlayer) return;
    if (selectedTile.owner !== user.uid && selectedTile.structureType !== 'MINE_WILD') {
        showNotification("Bu toprak senin deƒüil!");
        return;
    }
    if (selectedTile.structureType && selectedTile.structureType !== 'MINE_WILD') {
        showNotification("Burada zaten bina var.");
        return;
    }
    if (selectedTile.unit) {
        showNotification("√ñnce birimi √ßek.");
        return;
    }

    const building = BUILDINGS[buildingKey];
    if (myPlayer.resources.oil < building.cost.oil || 
        myPlayer.resources.wheat < building.cost.wheat || 
        myPlayer.resources.dollar < building.cost.dollar) {
        showNotification("Kaynak yetersiz!");
        return;
    }

    if (selectedTile.structureType === 'MINE_WILD') {
        showNotification("Madenlerin √ºzerine bina yapƒ±lamaz.");
        return;
    }

    const updatedMap = JSON.parse(JSON.stringify(gameData.map));
    updatedMap[selectedTile.y][selectedTile.x].structureType = building.id;
    updatedMap[selectedTile.y][selectedTile.x].owner = user.uid;
    updatedMap[selectedTile.y][selectedTile.x].hp = 500;

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
        map: updatedMap,
        [`players.${user.uid}.resources.oil`]: increment(-building.cost.oil),
        [`players.${user.uid}.resources.wheat`]: increment(-building.cost.wheat),
        [`players.${user.uid}.resources.dollar`]: increment(-building.cost.dollar),
    });
    setSelectedTile(null);
  };

  const trainUnit = async (unitKey) => {
     if (!selectedTile || !myPlayer) return;
     if (selectedTile.structureType !== 'BARRACKS' || selectedTile.owner !== user.uid) {
         showNotification("Sadece Kƒ±≈ülada asker √ºretilir.");
         return;
     }
     if (selectedTile.unit) {
         showNotification("Kƒ±≈üla dolu.");
         return;
     }

     const unit = UNITS[unitKey];
     if (myPlayer.resources.oil < unit.cost.oil || 
        myPlayer.resources.wheat < unit.cost.wheat || 
        myPlayer.resources.dollar < unit.cost.dollar) {
        showNotification("Kaynak yetersiz!");
        return;
    }

    const updatedMap = JSON.parse(JSON.stringify(gameData.map));
    updatedMap[selectedTile.y][selectedTile.x].unit = {
        type: unitKey,
        hp: unit.hp,
        maxHp: unit.hp,
        owner: user.uid
    };

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
        map: updatedMap,
        [`players.${user.uid}.resources.oil`]: increment(-unit.cost.oil),
        [`players.${user.uid}.resources.wheat`]: increment(-unit.cost.wheat),
        [`players.${user.uid}.resources.dollar`]: increment(-unit.cost.dollar),
    });
    setSelectedTile(null);
  };

  const offerPact = async (targetPlayerId) => {
      if (myPlayer.resources.dollar < 500) { showNotification("Diplomasi i√ßin 500$ lazƒ±m."); return; }
      const duration = 5 * 60 * 1000; // 5 min
      const expiry = Date.now() + duration;

      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
          [`players.${user.uid}.diplomacy.${targetPlayerId}`]: expiry,
          [`players.${targetPlayerId}.diplomacy.${user.uid}`]: expiry,
          [`players.${user.uid}.resources.dollar`]: increment(-500)
      });
      showNotification("Pakt imzalandƒ± (5 dk)");
  };

  const postMarketOffer = async (resource, amount, price) => {
      if (!resource || !amount || !price) return;
      if (myPlayer.resources[resource.toLowerCase()] < amount) { showNotification("Yetersiz kaynak."); return; }

      const offer = {
          id: Date.now().toString(),
          seller: user.uid,
          sellerName: myPlayer.name,
          resource,
          amount: parseInt(amount),
          price: parseInt(price)
      };

      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
          market: arrayUnion(offer),
          [`players.${user.uid}.resources.${resource.toLowerCase()}`]: increment(-amount)
      });
      showNotification("ƒ∞lan eklendi.");
  };

  const buyMarketOffer = async (offer) => {
      if (myPlayer.resources.dollar < offer.price) { showNotification("Paran yetmiyor."); return; }
      
      const newMarket = gameData.market.filter(o => o.id !== offer.id);
      if (newMarket.length === gameData.market.length) { showNotification("ƒ∞lan artƒ±k yok."); return; }

      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `game_${gameCode}`), {
          market: newMarket,
          [`players.${user.uid}.resources.dollar`]: increment(-offer.price),
          [`players.${user.uid}.resources.${offer.resource.toLowerCase()}`]: increment(offer.amount),
          [`players.${offer.seller}.resources.dollar`]: increment(offer.price)
      });
      showNotification("Satƒ±n alƒ±ndƒ±!");
  };

  // --- RENDERING ---

  if (!user) return <div className="flex items-center justify-center h-screen bg-gray-900 text-white">Y√ºkleniyor...</div>;

  return (
    <div className="flex flex-col h-screen bg-gray-900 text-gray-100 overflow-hidden font-sans">
      {/* Notification Toast */}
      {notification && (
        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black px-6 py-2 rounded-lg shadow-xl z-50 font-bold animate-bounce pointer-events-none">
          {notification}
        </div>
      )}

      {/* --- MENU SCREEN --- */}
      {gameState === 'menu' && (
        <div className="flex flex-col items-center justify-center h-full space-y-8 bg-[url('https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80')] bg-cover bg-blend-multiply bg-gray-800">
          <h1 className="text-6xl font-black text-yellow-500 tracking-tighter uppercase drop-shadow-lg">Taktik Komuta</h1>
          <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-96 opacity-95">
            <h2 className="text-xl mb-4 font-bold text-center">√úlkeni Se√ß</h2>
            <div className="grid grid-cols-5 gap-2 mb-6">
              {COUNTRIES.map(c => (
                <button 
                    key={c.code}
                    onClick={() => setSelectedCountry(c)}
                    className={`p-2 rounded text-2xl transition hover:scale-110 ${selectedCountry.code === c.code ? 'ring-2 ring-yellow-400 bg-gray-700' : ''}`}
                    title={c.name}
                >
                  {c.flag}
                </button>
              ))}
            </div>
            <div className="text-center mb-6 text-yellow-400 font-bold">{selectedCountry.name} Ordusu Hazƒ±r!</div>
            
            <div className="flex flex-col gap-4">
              <button onClick={createGame} disabled={loading} className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2">
                {loading ? '...' : 'Yeni Operasyon Ba≈ülat'} <Zap size={20} />
              </button>
              <div className="flex gap-2">
                <input 
                    type="text" 
                    placeholder="Eri≈üim Kodu" 
                    className="bg-gray-700 text-white px-4 rounded-lg w-full uppercase tracking-widest text-center"
                    onChange={(e) => setGameCode(e.target.value)}
                    maxLength={6}
                />
                <button onClick={() => joinGame(gameCode)} disabled={loading} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">
                  Katƒ±l
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- LOBBY SCREEN --- */}
      {gameState === 'lobby' && gameData && (
        <div className="flex flex-col items-center justify-center h-full bg-gray-800">
          <div className="bg-gray-700 p-8 rounded-2xl w-[600px] shadow-2xl">
            <h2 className="text-3xl font-bold text-center mb-2">Operasyon Odasƒ±</h2>
            <p className="text-center text-4xl font-mono text-yellow-400 tracking-[0.5em] mb-8 bg-black/30 py-4 rounded-lg select-all cursor-pointer" onClick={() => {navigator.clipboard.writeText(gameData.code); showNotification("Kod Kopyalandƒ±!");}}>
                {gameData.code}
            </p>
            
            <div className="space-y-2 mb-8">
                {Object.values(gameData.players).map(p => (
                    <div key={p.id} className="flex items-center justify-between bg-gray-600 p-3 rounded">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{p.country.flag}</span>
                            <span className="font-bold">{p.name} {p.id === gameData.host ? '(Y√∂netici)' : ''}</span>
                        </div>
                        <span className="text-green-400">‚óè √áevrimi√ßi</span>
                    </div>
                ))}
            </div>

            {gameData.host === user.uid ? (
                 <button onClick={startGame} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-lg font-bold text-xl">
                     OPERASYONU BA≈ûLAT
                 </button>
            ) : (
                <div className="text-center text-gray-400 animate-pulse">Y√∂netici bekleniyor...</div>
            )}
          </div>
        </div>
      )}

      {/* --- GAME SCREEN --- */}
      {gameState === 'game' && gameData && myPlayer && (
        <div className="flex flex-1 overflow-hidden">
          
          {/* LEFT SIDEBAR - INFO & ACTIONS */}
          <div className="w-80 bg-gray-800 border-r border-gray-700 flex flex-col z-20 shadow-xl">
             {/* Player Header */}
             <div className="p-4 bg-gray-900 border-b border-gray-700">
                 <div className="flex items-center gap-3 mb-2">
                     <span className="text-4xl">{myPlayer.country.flag}</span>
                     <div>
                         <h3 className="font-bold text-lg leading-none">{myPlayer.name}</h3>
                         <span className="text-xs text-gray-400">ID: {user.uid.slice(0,6)}</span>
                     </div>
                 </div>
                 
                 {/* Resources Grid */}
                 <div className="grid grid-cols-2 gap-2 mt-4 text-sm">
                     {Object.entries(RESOURCES).map(([key, res]) => (
                         <div key={key} className={`flex items-center gap-1 ${res.color} bg-gray-800 p-1 rounded border border-gray-700`}>
                             <span>{res.icon}</span>
                             <span className="font-mono font-bold">{myPlayer.resources[res.id]}</span>
                         </div>
                     ))}
                 </div>
                 <div className="flex gap-2 mt-2">
                    <button onClick={() => buyResource('AMMO')} className="flex-1 bg-blue-900/50 hover:bg-blue-800 text-xs py-1 px-2 rounded border border-blue-700 flex items-center justify-center gap-1">
                        +50 {RESOURCES.AMMO.icon} (50{RESOURCES.OIL.icon} 50{RESOURCES.WHEAT.icon})
                    </button>
                    <button onClick={() => buyResource('MOVE')} className="flex-1 bg-orange-900/50 hover:bg-orange-800 text-xs py-1 px-2 rounded border border-orange-700 flex items-center justify-center gap-1">
                        +50 {RESOURCES.MOVE.icon} (50{RESOURCES.OIL.icon} 50{RESOURCES.DOLLAR.icon})
                    </button>
                 </div>
             </div>

             {/* Selection Info */}
             <div className="flex-1 p-4 overflow-y-auto">
                 {selectedTile ? (
                     <div className="animate-in fade-in slide-in-from-left-4 duration-300">
                         <h4 className="text-yellow-400 font-bold uppercase text-xs tracking-wider mb-2">Se√ßili B√∂lge ({selectedTile.x}, {selectedTile.y})</h4>
                         
                         {/* Tile Info */}
                         <div className="bg-gray-700 p-3 rounded-lg mb-4 text-sm">
                            {selectedTile.owner ? (
                                <div className="flex items-center gap-2 mb-2">
                                    <span>{gameData.players[selectedTile.owner]?.country.flag}</span>
                                    <span className={selectedTile.owner === user.uid ? 'text-green-400' : 'text-red-400'}>
                                        {gameData.players[selectedTile.owner]?.name}
                                    </span>
                                </div>
                            ) : <div className="text-gray-400 mb-2">Sahipsiz Toprak</div>}
                            
                            {selectedTile.structureType && (
                                <div className="flex justify-between items-center border-t border-gray-600 pt-2">
                                    <span className="font-bold">
                                        {(selectedTile.structureType === 'MINE' || selectedTile.structureType === 'MINE_WILD') ? 
                                        `MADEN (${selectedTile.resourceType})` : 
                                        BUILDINGS[selectedTile.structureType]?.name}
                                    </span>
                                    <span className="text-xs text-gray-400">HP: {selectedTile.hp || 100}</span>
                                </div>
                            )}
                            
                            {selectedTile.unit && (
                                <div className="flex justify-between items-center border-t border-gray-600 pt-2 mt-2">
                                    <span className="font-bold flex items-center gap-1">{UNITS[selectedTile.unit.type].icon} {UNITS[selectedTile.unit.type].name}</span>
                                    <div className="flex flex-col items-end text-xs">
                                        <span className="text-green-400">HP: {selectedTile.unit.hp}</span>
                                        <span className="text-red-400">DMG: {UNITS[selectedTile.unit.type].damage}</span>
                                    </div>
                                </div>
                            )}
                         </div>

                         {/* Actions if Owned */}
                         {selectedTile.owner === user.uid && !selectedTile.unit && !selectedTile.structureType?.includes('MINE') && (
                             <div className="space-y-2">
                                 {!selectedTile.structureType && (
                                     <>
                                        <div className="text-xs text-gray-400 mb-1">Bina ƒ∞n≈üa Et</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {Object.entries(BUILDINGS).filter(([k]) => k !== 'HQ').map(([key, b]) => (
                                                <button key={key} onClick={() => buildStructure(key)} className="bg-gray-700 hover:bg-gray-600 p-2 rounded text-left text-xs border border-gray-600 transition">
                                                    <div className="font-bold">{b.icon} {b.name}</div>
                                                    <div className="text-[10px] text-gray-400 mt-1">
                                                        {b.cost.oil > 0 && `${b.cost.oil}üõ¢Ô∏è `} 
                                                        {b.cost.wheat > 0 && `${b.cost.wheat}üåæ `}
                                                        {b.cost.dollar > 0 && `${b.cost.dollar}üíµ`}
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                     </>
                                 )}

                                 {selectedTile.structureType === 'BARRACKS' && (
                                     <>
                                        <div className="text-xs text-gray-400 mb-1 mt-4">Asker Eƒüit</div>
                                        <div className="space-y-2">
                                            {Object.entries(UNITS).map(([key, u]) => (
                                                <button key={key} onClick={() => trainUnit(key)} className="w-full bg-gray-700 hover:bg-gray-600 p-2 rounded flex justify-between items-center border border-gray-600 transition group">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xl group-hover:scale-125 transition">{u.icon}</span>
                                                        <div className="flex flex-col items-start">
                                                            <span className="text-sm font-bold">{u.name}</span>
                                                            <span className="text-[10px] text-gray-400">Menzil: {u.range}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-[10px] text-right text-gray-400">
                                                        <div>{u.cost.oil}üõ¢Ô∏è {u.cost.wheat}üåæ</div>
                                                        <div>{u.cost.dollar}üíµ</div>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                     </>
                                 )}
                             </div>
                         )}

                         {/* Actions if Enemy */}
                         {selectedTile.owner && selectedTile.owner !== user.uid && (
                             <div className="mt-4">
                                 <button onClick={() => offerPact(selectedTile.owner)} className="w-full bg-blue-900 hover:bg-blue-800 text-blue-100 py-2 rounded flex items-center justify-center gap-2 text-sm border border-blue-700">
                                     <Handshake size={16} /> Saldƒ±rmazlƒ±k Paktƒ± (500$)
                                 </button>
                             </div>
                         )}
                     </div>
                 ) : (
                     <div className="text-gray-500 text-center text-sm italic mt-10">
                        Haritadan bir kare se√ßin...
                     </div>
                 )}
             </div>

             {/* Market Mini View */}
             <div className="p-2 border-t border-gray-700 bg-gray-900 h-48 overflow-y-auto">
                 <h4 className="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1"><ShoppingCart size={12}/> KARABORSA</h4>
                 
                 {/* Post Offer UI */}
                 <div className="flex gap-1 mb-2">
                     <select id="mRes" className="bg-gray-700 text-xs rounded w-16">
                         <option value="OIL">Petrol</option>
                         <option value="WHEAT">Buƒüday</option>
                     </select>
                     <input id="mAmt" type="number" placeholder="Adet" className="bg-gray-700 text-xs w-12 rounded pl-1" defaultValue={100}/>
                     <input id="mPrc" type="number" placeholder="Fiyat" className="bg-gray-700 text-xs w-12 rounded pl-1" defaultValue={200}/>
                     <button 
                        onClick={() => postMarketOffer(document.getElementById('mRes').value, document.getElementById('mAmt').value, document.getElementById('mPrc').value)}
                        className="bg-green-700 hover:bg-green-600 text-xs px-2 rounded"
                     >+</button>
                 </div>

                 <div className="space-y-1">
                     {marketOffers.map(offer => (
                         <div key={offer.id} className="flex justify-between items-center bg-gray-800 p-1 rounded text-xs border border-gray-700">
                             <div className="flex items-center gap-1">
                                 <span>{offer.resource === 'OIL' ? 'üõ¢Ô∏è' : 'üåæ'}</span>
                                 <span className="font-bold">{offer.amount}</span>
                             </div>
                             <div className="flex items-center gap-2">
                                 <span className="text-green-400">{offer.price}$</span>
                                 {offer.seller !== user.uid && (
                                     <button onClick={() => buyMarketOffer(offer)} className="bg-green-800 px-1 rounded hover:bg-green-700">Al</button>
                                 )}
                             </div>
                         </div>
                     ))}
                 </div>
             </div>
          </div>

          {/* MAIN MAP AREA */}
          <div className="flex-1 overflow-auto bg-black relative cursor-move" style={{
              backgroundImage: 'radial-gradient(#333 1px, transparent 1px)',
              backgroundSize: '20px 20px'
          }}>
              {/* Map Grid */}
              <div className="p-10 min-w-max min-h-max">
                  <div 
                    className="grid gap-px bg-gray-800 border-4 border-gray-700 shadow-2xl"
                    style={{ gridTemplateColumns: `repeat(${MAP_SIZE}, 60px)` }}
                  >
                      {gameData.map.map((row, y) => (
                          row.map((tile, x) => {
                              // Render Logic
                              const isSelected = selectedTile?.x === x && selectedTile?.y === y;
                              const ownerData = tile.owner ? gameData.players[tile.owner] : null;
                              
                              let bgClass = "bg-[#2d3748]"; // Base ground
                              if (tile.resourceType === 'oil') bgClass = "bg-gray-800";
                              if (tile.resourceType === 'wheat') bgClass = "bg-yellow-900/30";
                              if (tile.resourceType === 'dollar') bgClass = "bg-green-900/30";
                              
                              return (
                                  <div 
                                    key={`${x}-${y}`}
                                    onClick={() => handleTileClick(x, y)}
                                    className={`
                                        w-[60px] h-[60px] relative flex items-center justify-center select-none transition-all duration-100
                                        ${bgClass}
                                        ${isSelected ? 'ring-4 ring-yellow-400 z-10 scale-105' : 'hover:bg-opacity-80 hover:ring-2 hover:ring-gray-500'}
                                    `}
                                  >
                                      {/* Ownership Indicator */}
                                      {tile.owner && (
                                          <div className={`absolute inset-0 opacity-20 ${ownerData?.country.color || 'bg-white'}`} />
                                      )}
                                      
                                      {/* Resource / Structure Icon */}
                                      {tile.structureType === 'MINE_WILD' && (
                                          <div className="absolute text-xl opacity-70 animate-pulse">
                                              {tile.resourceType === 'oil' ? 'üõ¢Ô∏è' : tile.resourceType === 'wheat' ? 'üåæ' : 'üíµ'}
                                          </div>
                                      )}
                                      
                                      {/* Building */}
                                      {tile.structureType && tile.structureType !== 'MINE_WILD' && (
                                          <div className="absolute z-10 text-2xl drop-shadow-md">
                                              {tile.structureType === 'MINE' ? 
                                                (tile.resourceType === 'oil' ? 'üõ¢Ô∏è' : tile.resourceType === 'wheat' ? 'üåæ' : 'üíµ') : 
                                                BUILDINGS[tile.structureType]?.icon
                                              }
                                              {/* Level Indicator Dot */}
                                              <div className="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full border border-black"></div>
                                          </div>
                                      )}

                                      {/* Unit */}
                                      {tile.unit && (
                                          <div className="absolute z-20 text-3xl transform hover:-translate-y-1 transition drop-shadow-xl">
                                              {UNITS[tile.unit.type].icon}
                                              {/* HP Bar */}
                                              <div className="absolute -bottom-1 left-0 w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                                                  <div className="h-full bg-green-500" style={{width: `${(tile.unit.hp / tile.unit.maxHp) * 100}%`}}></div>
                                              </div>
                                          </div>
                                      )}

                                      {/* Flag Overlay for Owner */}
                                      {ownerData && !tile.unit && (
                                          <div className="absolute bottom-1 right-1 text-[10px] opacity-60">
                                              {ownerData.country.flag}
                                          </div>
                                      )}
                                  </div>
                              );
                          })
                      ))}
                  </div>
              </div>
          </div>
        </div>
      )}
    </div>
  );
}
