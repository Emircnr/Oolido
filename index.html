<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taktik Komuta - RTS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* √ñzel Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(32, 60px);
            gap: 1px;
            background-color: #2d3748;
            border: 4px solid #4a5568;
        }
        .tile {
            width: 60px; height: 60px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }
        .tile:hover { opacity: 0.8; z-index: 5; transform: scale(1.05); border: 1px solid white; }
        .selected { box-shadow: 0 0 0 4px #ecc94b; z-index: 10; transform: scale(1.05); }
        
        .hp-bar {
            position: absolute; bottom: 2px; left: 2px; right: 2px;
            height: 4px; background: #4a5568; border-radius: 2px; overflow: hidden;
        }
        .hp-fill { height: 100%; background: #48bb78; }
        
        /* Animasyonlar */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-custom { animation: bounce 1s infinite; }
        
        .modal { background: rgba(0,0,0,0.8); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black px-6 py-2 rounded-lg shadow-xl z-50 font-bold pointer-events-none transition-opacity duration-300"></div>

    <!-- App Container -->
    <div id="app" class="w-full h-full">
        <!-- Loading Screen -->
        <div id="loading-screen" class="flex items-center justify-center h-full">
            <div class="text-2xl animate-pulse">Sunucuya Baƒülanƒ±lƒ±yor...</div>
        </div>

        <!-- Menu Screen -->
        <div id="menu-screen" class="hidden flex flex-col items-center justify-center h-full space-y-8 bg-gray-800 bg-cover bg-blend-multiply" style="background-image: url('https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80');">
            <h1 class="text-6xl font-black text-yellow-500 tracking-tighter uppercase drop-shadow-lg text-center">Taktik<br>Komuta</h1>
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-96 opacity-95">
                <h2 class="text-xl mb-4 font-bold text-center">√úlkeni Se√ß</h2>
                <div id="country-list" class="grid grid-cols-5 gap-2 mb-6"></div>
                <div id="selected-country-name" class="text-center mb-6 text-yellow-400 font-bold"></div>
                
                <div class="flex flex-col gap-4">
                    <button id="btn-create-game" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2 transition">
                        ‚ö° Yeni Operasyon
                    </button>
                    <div class="flex gap-2">
                        <input id="input-game-code" type="text" placeholder="KOD" maxlength="6" class="bg-gray-700 text-white px-4 rounded-lg w-full uppercase tracking-widest text-center font-mono">
                        <button id="btn-join-game" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg transition">Katƒ±l</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden flex flex-col items-center justify-center h-full bg-gray-800">
            <div class="bg-gray-700 p-8 rounded-2xl w-full max-w-2xl shadow-2xl">
                <h2 class="text-3xl font-bold text-center mb-2">Operasyon Odasƒ±</h2>
                <div id="lobby-code-display" class="text-center text-4xl font-mono text-yellow-400 tracking-[0.5em] mb-8 bg-black/30 py-4 rounded-lg cursor-pointer hover:bg-black/50 transition" title="Kodu Kopyala"></div>
                
                <div id="lobby-player-list" class="space-y-2 mb-8 max-h-64 overflow-y-auto"></div>

                <div id="lobby-host-controls" class="hidden">
                    <button id="btn-start-game" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-lg font-bold text-xl transition">OPERASYONU BA≈ûLAT</button>
                </div>
                <div id="lobby-waiting-msg" class="text-center text-gray-400 animate-pulse hidden">Komutanƒ±n ba≈ülatmasƒ± bekleniyor...</div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden flex h-full">
            <!-- Sidebar -->
            <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col z-20 shadow-xl shrink-0">
                <!-- Player Info -->
                <div class="p-4 bg-gray-900 border-b border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span id="p-flag" class="text-4xl"></span>
                        <div>
                            <h3 id="p-name" class="font-bold text-lg leading-none"></h3>
                            <span id="p-id" class="text-xs text-gray-400"></span>
                        </div>
                    </div>
                    <!-- Resources -->
                    <div id="resource-list" class="grid grid-cols-2 gap-2 mt-4 text-sm"></div>
                    <!-- Quick Actions -->
                    <div class="flex gap-2 mt-2">
                        <button id="btn-buy-ammo" class="flex-1 bg-blue-900/50 hover:bg-blue-800 text-xs py-1 px-1 rounded border border-blue-700 flex flex-col items-center justify-center gap-1 transition">
                            <span>+50 üîπ</span> <span class="text-[10px] opacity-70">50üõ¢Ô∏è 50üåæ</span>
                        </button>
                        <button id="btn-buy-move" class="flex-1 bg-orange-900/50 hover:bg-orange-800 text-xs py-1 px-1 rounded border border-orange-700 flex flex-col items-center justify-center gap-1 transition">
                            <span>+50 üëü</span> <span class="text-[10px] opacity-70">50üõ¢Ô∏è 50üíµ</span>
                        </button>
                    </div>
                </div>

                <!-- Selection Info -->
                <div id="selection-panel" class="flex-1 p-4 overflow-y-auto bg-gray-800">
                    <div id="no-selection" class="text-gray-500 text-center text-sm italic mt-10">Haritadan bir kare se√ßin...</div>
                    <div id="selection-content" class="hidden animate-bounce-custom-stop">
                        <h4 id="sel-title" class="text-yellow-400 font-bold uppercase text-xs tracking-wider mb-2"></h4>
                        <div class="bg-gray-700 p-3 rounded-lg mb-4 text-sm">
                            <div id="sel-owner" class="mb-2"></div>
                            <div id="sel-structure" class="hidden border-t border-gray-600 pt-2 mt-1"></div>
                            <div id="sel-unit" class="hidden border-t border-gray-600 pt-2 mt-1"></div>
                        </div>

                        <!-- Action Buttons Container -->
                        <div id="sel-actions" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Market -->
                <div class="p-2 border-t border-gray-700 bg-gray-900 h-48 overflow-y-auto flex flex-col">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1">üõí KARABORSA</h4>
                    <div class="flex gap-1 mb-2">
                        <select id="market-res" class="bg-gray-700 text-xs rounded w-16 px-1"><option value="OIL">Petrol</option><option value="WHEAT">Buƒüday</option></select>
                        <input id="market-amt" type="number" value="100" class="bg-gray-700 text-xs w-12 rounded pl-1">
                        <input id="market-price" type="number" value="200" class="bg-gray-700 text-xs w-12 rounded pl-1">
                        <button id="btn-post-offer" class="bg-green-700 hover:bg-green-600 text-xs px-2 rounded font-bold">+</button>
                    </div>
                    <div id="market-list" class="space-y-1 flex-1 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Map Area -->
            <div id="map-container" class="flex-1 overflow-auto bg-black relative cursor-move" style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;">
                <div class="p-10 min-w-max min-h-max">
                    <div id="game-map" class="map-grid shadow-2xl"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, 
            arrayUnion, increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & CONSTANTS ---
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCbolraCD1nrOqcIE5GHPAaX9SRhHQXYIY",
            authDomain: "videoanlyze.firebaseapp.com",
            projectId: "videoanlyze",
            storageBucket: "videoanlyze.firebasestorage.app",
            messagingSenderId: "1053069335615",
            appId: "1:1053069335615:web:5dbf8f2345a5bf18b1ac8a",
            measurementId: "G-TLEWYXX05H"
        };
        const APP_ID = (typeof __app_id !== 'undefined') ? __app_id : 'videoanlyze';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Game Data Constants
        const MAP_SIZE = 32;
        const COUNTRIES = [
            { code: 'TR', name: 'T√ºrkiye', flag: 'üáπüá∑', color: 'bg-red-600' },
            { code: 'US', name: 'ABD', flag: 'üá∫üá∏', color: 'bg-blue-600' },
            { code: 'RU', name: 'Rusya', flag: 'üá∑üá∫', color: 'bg-red-800' },
            { code: 'CN', name: '√áin', flag: 'üá®üá≥', color: 'bg-yellow-600' },
            { code: 'DE', name: 'Almanya', flag: 'üá©üá™', color: 'bg-gray-800' },
            { code: 'GB', name: 'ƒ∞ngiltere', flag: 'üá¨üáß', color: 'bg-blue-800' },
            { code: 'FR', name: 'Fransa', flag: 'üá´üá∑', color: 'bg-blue-500' },
            { code: 'JP', name: 'Japonya', flag: 'üáØüáµ', color: 'bg-red-400' },
            { code: 'KR', name: 'G√ºney Kore', flag: 'üá∞üá∑', color: 'bg-blue-400' },
            { code: 'BR', name: 'Brezilya', flag: 'üáßüá∑', color: 'bg-green-600' },
        ];
        const BUILDINGS = {
            HQ: { id: 'HQ', name: 'Karargah', icon: 'üèõÔ∏è', cost: { oil: 0, wheat: 0, dollar: 0 } },
            BARRACKS: { id: 'BARRACKS', name: 'Kƒ±≈üla', icon: 'üè†', cost: { oil: 200, wheat: 100, dollar: 300 } },
            TOWER: { id: 'TOWER', name: 'Savunma Kulesi', icon: 'üóº', cost: { oil: 150, wheat: 50, dollar: 200 }, range: 3, damage: 20 },
            RADAR: { id: 'RADAR', name: 'Radar', icon: 'üì°', cost: { oil: 100, wheat: 0, dollar: 500 }, range: 8 },
            HOSPITAL: { id: 'HOSPITAL', name: 'Hastane', icon: 'üè•', cost: { oil: 100, wheat: 300, dollar: 200 }, range: 2 },
        };
        const UNITS = {
            INFANTRY: { id: 'INFANTRY', name: 'Piyade', icon: 'üî´', cost: { oil: 50, wheat: 50, dollar: 50 }, hp: 100, damage: 15, range: 2, moveCost: 10, ammoCost: 10 },
            HEAVY: { id: 'HEAVY', name: 'Aƒüƒ±r Piyade', icon: 'üí™', cost: { oil: 150, wheat: 100, dollar: 100 }, hp: 250, damage: 25, range: 1, moveCost: 20, ammoCost: 20 },
            SNIPER: { id: 'SNIPER', name: 'Keskin Ni≈üancƒ±', icon: 'üéØ', cost: { oil: 50, wheat: 100, dollar: 200 }, hp: 60, damage: 60, range: 5, moveCost: 15, ammoCost: 30 },
            SCOUT: { id: 'SCOUT', name: 'Ke≈üif√ßi', icon: 'üèÉ', cost: { oil: 100, wheat: 50, dollar: 50 }, hp: 80, damage: 5, range: 3, moveCost: 5, ammoCost: 5 },
        };
        const RESOURCES = {
            OIL: { id: 'oil', name: 'Petrol', icon: 'üõ¢Ô∏è', color: 'text-gray-400' },
            WHEAT: { id: 'wheat', name: 'Buƒüday', icon: 'üåæ', color: 'text-yellow-600' },
            DOLLAR: { id: 'dollar', name: 'Dolar', icon: 'üíµ', color: 'text-green-600' },
            AMMO: { id: 'ammo', name: 'M√ºhimmat', icon: 'üîπ', color: 'text-blue-500' },
            MOVE: { id: 'move', name: 'Hareket', icon: 'üëü', color: 'text-orange-500' },
        };

        // --- STATE ---
        let currentUser = null;
        let gameState = 'menu'; // menu, lobby, game
        let currentGameCode = '';
        let gameData = null;
        let selectedCountry = COUNTRIES[0];
        let selectedTile = null;
        let unsubGame = null;
        let productionInterval = null;

        // --- HELPER FUNCTIONS ---
        const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const showNotification = (msg) => {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        };
        const el = (id) => document.getElementById(id);

        // --- AUTH ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                el('loading-screen').classList.add('hidden');
                switchState('menu');
            }
        });
        initAuth();

        // --- UI SWITCHER ---
        const switchState = (newState) => {
            gameState = newState;
            ['menu-screen', 'lobby-screen', 'game-screen'].forEach(id => el(id).classList.add('hidden'));
            el(`${newState}-screen`).classList.remove('hidden');

            if (newState === 'menu') renderMenu();
        };

        // --- MENU LOGIC ---
        const renderMenu = () => {
            const list = el('country-list');
            list.innerHTML = '';
            COUNTRIES.forEach(c => {
                const btn = document.createElement('button');
                btn.className = `p-2 rounded text-2xl transition hover:scale-110 ${selectedCountry.code === c.code ? 'ring-2 ring-yellow-400 bg-gray-700' : ''}`;
                btn.innerText = c.flag;
                btn.onclick = () => {
                    selectedCountry = c;
                    renderMenu();
                };
                list.appendChild(btn);
            });
            el('selected-country-name').innerText = `${selectedCountry.name} Ordusu Hazƒ±r!`;
        };

        el('btn-create-game').onclick = async () => {
            if (!currentUser) return;
            el('btn-create-game').innerText = "Olu≈üturuluyor...";
            const code = generateCode();
            
            // Map generation
            const newMap = [];
            for (let y = 0; y < MAP_SIZE; y++) {
                const row = [];
                for (let x = 0; x < MAP_SIZE; x++) {
                    let resource = null;
                    let production = 0;
                    if (Math.random() < 0.10) {
                        const rRand = Math.random();
                        if (rRand < 0.33) { resource = 'oil'; production = getRandomInt(500, 2000); }
                        else if (rRand < 0.66) { resource = 'wheat'; production = getRandomInt(500, 2000); }
                        else { resource = 'dollar'; production = getRandomInt(500, 2000); }
                    }
                    row.push({
                        x, y,
                        resourceType: resource,
                        maxReserve: production * 10,
                        production: Math.floor(production / 50),
                        structureType: resource ? 'MINE_WILD' : null,
                        unit: null,
                        owner: null,
                        hp: resource ? 500 : 0
                    });
                }
                newMap.push(row);
            }

            const initialData = {
                code,
                host: currentUser.uid,
                status: 'lobby',
                createdAt: Date.now(),
                players: {
                    [currentUser.uid]: {
                        id: currentUser.uid,
                        name: `Komutan ${currentUser.uid.slice(0,4)}`,
                        country: selectedCountry,
                        resources: { oil: 500, wheat: 500, dollar: 500, ammo: 50, move: 50 },
                        diplomacy: {}
                    }
                },
                map: newMap,
                market: []
            };

            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${code}`), initialData);
                joinGameSuccess(code);
            } catch (e) { console.error(e); showNotification("Hata olu≈ütu."); }
            el('btn-create-game').innerHTML = `‚ö° Yeni Operasyon`;
        };

        el('btn-join-game').onclick = async () => {
            const code = el('input-game-code').value;
            if (!code) return;
            const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${code}`);
            try {
                const snap = await getDoc(gameRef);
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.status !== 'lobby' && !data.players[currentUser.uid]) {
                        showNotification("Oyun ba≈ülamƒ±≈ü."); return;
                    }
                    if (Object.keys(data.players).length >= 10 && !data.players[currentUser.uid]) {
                        showNotification("Oda dolu."); return;
                    }
                    if (!data.players[currentUser.uid]) {
                        await updateDoc(gameRef, {
                            [`players.${currentUser.uid}`]: {
                                id: currentUser.uid,
                                name: `Komutan ${currentUser.uid.slice(0,4)}`,
                                country: selectedCountry,
                                resources: { oil: 500, wheat: 500, dollar: 500, ammo: 50, move: 50 },
                                diplomacy: {}
                            }
                        });
                    }
                    joinGameSuccess(code);
                } else { showNotification("Kod hatalƒ±."); }
            } catch (e) { console.error(e); }
        };

        const joinGameSuccess = (code) => {
            currentGameCode = code;
            subscribeToGame(code);
            switchState('lobby');
        };

        // --- GAME SUBSCRIPTION & LOGIC ---
        const subscribeToGame = (code) => {
            if (unsubGame) unsubGame();
            const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${code}`);
            
            unsubGame = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showNotification("Oyun sonlandƒ±.");
                    switchState('menu');
                    return;
                }
                const oldData = gameData;
                gameData = docSnap.data();

                if (gameState === 'lobby') updateLobbyUI();
                if (gameData.status === 'game' && gameState !== 'game') {
                    switchState('game');
                    initGameLoop();
                }
                if (gameState === 'game') updateGameUI(oldData);
            });
        };

        // --- LOBBY LOGIC ---
        const updateLobbyUI = () => {
            el('lobby-code-display').innerText = gameData.code;
            el('lobby-code-display').onclick = () => { navigator.clipboard.writeText(gameData.code); showNotification("Kod Kopyalandƒ±!"); };
            
            const list = el('lobby-player-list');
            list.innerHTML = '';
            Object.values(gameData.players).forEach(p => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-gray-600 p-3 rounded";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${p.country.flag}</span>
                        <span class="font-bold">${p.name} ${p.id === gameData.host ? 'üëë' : ''}</span>
                    </div>
                    <span class="text-green-400">‚óè √áevrimi√ßi</span>
                `;
                list.appendChild(div);
            });

            if (gameData.host === currentUser.uid) {
                el('lobby-host-controls').classList.remove('hidden');
                el('lobby-waiting-msg').classList.add('hidden');
            } else {
                el('lobby-host-controls').classList.add('hidden');
                el('lobby-waiting-msg').classList.remove('hidden');
            }
        };

        el('btn-start-game').onclick = async () => {
            // Assign HQs
            const mapCopy = JSON.parse(JSON.stringify(gameData.map));
            const pIds = Object.keys(gameData.players);
            const positions = [];
            pIds.forEach(pid => {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 100) {
                    attempts++;
                    const rx = getRandomInt(2, MAP_SIZE - 3);
                    const ry = getRandomInt(2, MAP_SIZE - 3);
                    const tooClose = positions.some(p => Math.abs(p.x - rx) < 6 && Math.abs(p.y - ry) < 6);
                    if (!tooClose && !mapCopy[ry][rx].resourceType) {
                        mapCopy[ry][rx].structureType = 'HQ';
                        mapCopy[ry][rx].owner = pid;
                        mapCopy[ry][rx].hp = 1000;
                        positions.push({x: rx, y: ry});
                        placed = true;
                    }
                }
            });
            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                status: 'game',
                map: mapCopy
            });
        };

        // --- GAME LOGIC ---
        const initGameLoop = () => {
            // Render Map Grid Once
            const grid = el('game-map');
            grid.innerHTML = '';
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.id = `cell-${x}-${y}`;
                    cell.className = 'tile bg-[#2d3748]'; // Default color
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    // Event Delegation handled by container, but direct click works too
                    cell.onclick = () => handleTileClick(x, y);
                    grid.appendChild(cell);
                }
            }

            // Start Production Loop
            if (productionInterval) clearInterval(productionInterval);
            productionInterval = setInterval(handleProduction, 10000);
        };

        const handleProduction = async () => {
            if (!gameData || !currentUser) return;
            const myId = currentUser.uid;
            let oil = 0, wheat = 0, dollar = 0;
            
            // Client-side estimation & sync (Trusted client model for simplicity)
            gameData.map.forEach(row => row.forEach(tile => {
                if (tile.owner === myId && (tile.structureType === 'MINE' || tile.structureType === 'MINE_WILD')) {
                    if (tile.resourceType === 'oil') oil += tile.production || 10;
                    if (tile.resourceType === 'wheat') wheat += tile.production || 10;
                    if (tile.resourceType === 'dollar') dollar += tile.production || 10;
                }
            }));

            if (oil > 0 || wheat > 0 || dollar > 0) {
                const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`);
                await updateDoc(gameRef, {
                    [`players.${myId}.resources.oil`]: increment(oil),
                    [`players.${myId}.resources.wheat`]: increment(wheat),
                    [`players.${myId}.resources.dollar`]: increment(dollar)
                });
            }
        };

        const updateGameUI = (oldData) => {
            const myPlayer = gameData.players[currentUser.uid];
            if (!myPlayer) return;

            // Header
            el('p-flag').innerText = myPlayer.country.flag;
            el('p-name').innerText = myPlayer.name;
            el('p-id').innerText = `ID: ${myPlayer.id.slice(0,4)}`;

            // Resources
            const resContainer = el('resource-list');
            resContainer.innerHTML = '';
            Object.entries(RESOURCES).forEach(([key, r]) => {
                resContainer.innerHTML += `
                    <div class="flex items-center gap-1 ${r.color} bg-gray-800 p-1 rounded border border-gray-700">
                        <span>${r.icon}</span>
                        <span class="font-mono font-bold">${myPlayer.resources[r.id]}</span>
                    </div>
                `;
            });

            // Map Updates (Differential would be better, but full sweep is ok for 1000 cells)
            gameData.map.forEach((row, y) => {
                row.forEach((tile, x) => {
                    const cell = el(`cell-${x}-${y}`);
                    if (!cell) return;
                    
                    // Reset Content
                    cell.innerHTML = '';
                    
                    // Background
                    let bg = '#2d3748';
                    if (tile.resourceType === 'oil') bg = '#2d3748'; // Dark
                    if (tile.resourceType === 'wheat') bg = '#744210'; // Brownish
                    if (tile.resourceType === 'dollar') bg = '#22543d'; // Greenish
                    cell.style.backgroundColor = bg;

                    // Owner Overlay
                    if (tile.owner) {
                        const ownerP = gameData.players[tile.owner];
                        if (ownerP) {
                            const overlay = document.createElement('div');
                            overlay.className = `absolute inset-0 opacity-20 ${ownerP.country.color}`;
                            cell.appendChild(overlay);
                            
                            if (!tile.unit) {
                                const flag = document.createElement('div');
                                flag.className = "absolute bottom-1 right-1 text-[10px] opacity-60";
                                flag.innerText = ownerP.country.flag;
                                cell.appendChild(flag);
                            }
                        }
                    }

                    // Structure / Resource
                    if (tile.structureType) {
                        const div = document.createElement('div');
                        div.className = "absolute z-10 text-2xl drop-shadow-md";
                        if (tile.structureType === 'MINE_WILD') {
                            div.className += " opacity-70 animate-pulse";
                            div.innerText = tile.resourceType === 'oil' ? 'üõ¢Ô∏è' : tile.resourceType === 'wheat' ? 'üåæ' : 'üíµ';
                        } else if (tile.structureType === 'MINE') {
                             div.innerText = tile.resourceType === 'oil' ? 'üõ¢Ô∏è' : tile.resourceType === 'wheat' ? 'üåæ' : 'üíµ';
                             const dot = document.createElement('div');
                             dot.className = "absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full border border-black";
                             div.appendChild(dot);
                        } else {
                            div.innerText = BUILDINGS[tile.structureType]?.icon || '?';
                            // HP for buildings
                            if (tile.hp < 500) {
                                // Simple damage indicator
                                div.style.filter = "grayscale(50%) sepia(50%) hue-rotate(-50deg)";
                            }
                        }
                        cell.appendChild(div);
                    }

                    // Unit
                    if (tile.unit) {
                        const uDiv = document.createElement('div');
                        uDiv.className = "absolute z-20 text-3xl transform hover:-translate-y-1 transition drop-shadow-xl";
                        uDiv.innerText = UNITS[tile.unit.type].icon;
                        
                        // HP Bar
                        const hpBar = document.createElement('div');
                        hpBar.className = "absolute -bottom-1 left-0 w-full h-1 bg-gray-700 rounded-full overflow-hidden";
                        const fill = document.createElement('div');
                        fill.className = "h-full bg-green-500";
                        fill.style.width = `${(tile.unit.hp / tile.unit.maxHp) * 100}%`;
                        hpBar.appendChild(fill);
                        uDiv.appendChild(hpBar);
                        
                        cell.appendChild(uDiv);
                    }

                    // Selection Ring
                    if (selectedTile && selectedTile.x === x && selectedTile.y === y) {
                        cell.classList.add('selected');
                    } else {
                        cell.classList.remove('selected');
                    }
                });
            });

            // Market
            const mList = el('market-list');
            mList.innerHTML = '';
            (gameData.market || []).forEach(offer => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-800 p-1 rounded text-xs border border-gray-700";
                div.innerHTML = `
                    <div class="flex items-center gap-1">
                        <span>${offer.resource === 'OIL' ? 'üõ¢Ô∏è' : 'üåæ'}</span>
                        <span class="font-bold">${offer.amount}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">${offer.price}$</span>
                        ${offer.seller !== currentUser.uid ? `<button class="bg-green-800 px-1 rounded hover:bg-green-700 btn-buy" data-id="${offer.id}">Al</button>` : ''}
                    </div>
                `;
                // Add event listener for buy buttons dynamically
                const buyBtn = div.querySelector('.btn-buy');
                if(buyBtn) buyBtn.onclick = () => buyMarketOffer(offer);
                mList.appendChild(div);
            });

            // Re-render selection panel if selected
            if (selectedTile) renderSelectionPanel();
        };

        // --- INTERACTION ---
        window.handleTileClick = async (x, y) => {
            const clicked = gameData.map[y][x];
            const myPlayer = gameData.players[currentUser.uid];

            if (selectedTile && selectedTile.unit && selectedTile.owner === currentUser.uid) {
                if (selectedTile.x === x && selectedTile.y === y) {
                    selectedTile = null; renderSelectionPanel(); updateGameUI(); return;
                }

                const dx = Math.abs(selectedTile.x - x);
                const dy = Math.abs(selectedTile.y - y);
                const dist = Math.max(dx, dy);

                // MOVE
                const canEnter = !clicked.unit && (!clicked.structureType || clicked.structureType === 'MINE_WILD' || (clicked.structureType === 'MINE' && clicked.owner === currentUser.uid));
                
                if (canEnter && dist <= 1) {
                     const uType = UNITS[selectedTile.unit.type];
                     if (myPlayer.resources.move >= uType.moveCost) {
                         const mapCopy = JSON.parse(JSON.stringify(gameData.map));
                         mapCopy[y][x].unit = { ...selectedTile.unit };
                         mapCopy[y][x].owner = currentUser.uid;
                         mapCopy[selectedTile.y][selectedTile.x].unit = null;
                         
                         if (mapCopy[y][x].structureType === 'MINE_WILD') {
                             mapCopy[y][x].structureType = 'MINE';
                             mapCopy[y][x].owner = currentUser.uid;
                             showNotification("Maden ele ge√ßirildi!");
                         }

                         await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                             map: mapCopy,
                             [`players.${currentUser.uid}.resources.move`]: increment(-uType.moveCost)
                         });
                         selectedTile = null; renderSelectionPanel(); return;
                     } else { showNotification("Yetersiz Hareket Puanƒ±!"); }
                }

                // ATTACK
                if ((clicked.unit || (clicked.structureType && clicked.owner)) && clicked.owner !== currentUser.uid) {
                    // Pact Check
                    const pact = myPlayer.diplomacy?.[clicked.owner];
                    if (pact && pact > Date.now()) { showNotification("Saldƒ±rmazlƒ±k Paktƒ±!"); return; }

                    const uType = UNITS[selectedTile.unit.type];
                    if (dist <= uType.range) {
                        if (myPlayer.resources.ammo >= uType.ammoCost) {
                             const mapCopy = JSON.parse(JSON.stringify(gameData.map));
                             const target = mapCopy[y][x];
                             
                             if (target.unit) {
                                 target.unit.hp -= uType.damage;
                                 if (target.unit.hp <= 0) target.unit = null;
                             } else if (target.structureType) {
                                 target.hp = (target.hp || 500) - uType.damage;
                                 if (target.hp <= 0) { target.structureType = null; target.owner = null; }
                             }

                             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                                 map: mapCopy,
                                 [`players.${currentUser.uid}.resources.ammo`]: increment(-uType.ammoCost)
                             });
                             selectedTile = null; renderSelectionPanel(); return;
                        } else { showNotification("Yetersiz M√ºhimmat!"); }
                    } else { showNotification("Menzil dƒ±≈üƒ±!"); }
                    return;
                }
            }

            selectedTile = { ...clicked }; // Copy data to avoid ref issues
            renderSelectionPanel();
            updateGameUI(); // To highlight ring
        };

        const renderSelectionPanel = () => {
            const panel = el('selection-content');
            const noSel = el('no-selection');
            const actions = el('sel-actions');
            
            if (!selectedTile) {
                panel.classList.add('hidden');
                noSel.classList.remove('hidden');
                return;
            }

            noSel.classList.add('hidden');
            panel.classList.remove('hidden');
            
            el('sel-title').innerText = `SE√áƒ∞Lƒ∞ B√ñLGE (${selectedTile.x}, ${selectedTile.y})`;
            
            // Owner Info
            const ownerP = selectedTile.owner ? gameData.players[selectedTile.owner] : null;
            el('sel-owner').innerHTML = ownerP ? 
                `<span class="text-lg mr-2">${ownerP.country.flag}</span> <span class="font-bold text-${selectedTile.owner === currentUser.uid ? 'green' : 'red'}-400">${ownerP.name}</span>` : 
                `<span class="text-gray-400">Sahipsiz Toprak</span>`;

            // Struct
            const sDiv = el('sel-structure');
            if (selectedTile.structureType) {
                sDiv.classList.remove('hidden');
                const name = (selectedTile.structureType === 'MINE' || selectedTile.structureType === 'MINE_WILD') ? 
                    `MADEN (${selectedTile.resourceType})` : BUILDINGS[selectedTile.structureType]?.name;
                sDiv.innerHTML = `<div class="flex justify-between font-bold"><span>${name}</span> <span class="text-xs text-gray-400">HP: ${selectedTile.hp}</span></div>`;
            } else sDiv.classList.add('hidden');

            // Unit
            const uDiv = el('sel-unit');
            if (selectedTile.unit) {
                uDiv.classList.remove('hidden');
                const u = UNITS[selectedTile.unit.type];
                uDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${u.icon} ${u.name}</span>
                        <div class="text-right text-xs">
                            <div class="text-green-400">HP: ${selectedTile.unit.hp}</div>
                            <div class="text-red-400">DMG: ${u.damage}</div>
                        </div>
                    </div>`;
            } else uDiv.classList.add('hidden');

            // ACTIONS
            actions.innerHTML = '';
            
            if (selectedTile.owner === currentUser.uid) {
                // Build
                if (!selectedTile.structureType && !selectedTile.unit) {
                    Object.entries(BUILDINGS).filter(([k]) => k !== 'HQ').forEach(([key, b]) => {
                        const btn = document.createElement('button');
                        btn.className = "w-full bg-gray-700 hover:bg-gray-600 p-2 rounded text-left text-xs border border-gray-600 flex justify-between";
                        btn.innerHTML = `<span>${b.icon} ${b.name}</span> <span class="text-[10px] text-gray-400">${b.cost.oil}üõ¢Ô∏è ${b.cost.dollar}üíµ</span>`;
                        btn.onclick = () => buildAction(key);
                        actions.appendChild(btn);
                    });
                }
                // Train
                if (selectedTile.structureType === 'BARRACKS' && !selectedTile.unit) {
                    Object.entries(UNITS).forEach(([key, u]) => {
                        const btn = document.createElement('button');
                        btn.className = "w-full bg-gray-700 hover:bg-gray-600 p-2 rounded text-left text-xs border border-gray-600 flex justify-between";
                        btn.innerHTML = `<span>${u.icon} ${u.name}</span> <span class="text-[10px] text-gray-400">${u.cost.oil}üõ¢Ô∏è ${u.cost.dollar}üíµ</span>`;
                        btn.onclick = () => trainAction(key);
                        actions.appendChild(btn);
                    });
                }
            } else if (selectedTile.owner) {
                // Enemy Actions
                const btn = document.createElement('button');
                btn.className = "w-full bg-blue-900 hover:bg-blue-800 text-white p-2 rounded text-xs border border-blue-700";
                btn.innerHTML = `ü§ù Pakt Teklif Et (500$)`;
                btn.onclick = () => offerPact(selectedTile.owner);
                actions.appendChild(btn);
            }
        };

        // --- ACTION HANDLERS ---
        const buildAction = async (key) => {
            const myPlayer = gameData.players[currentUser.uid];
            const b = BUILDINGS[key];
            if (myPlayer.resources.oil < b.cost.oil || myPlayer.resources.dollar < b.cost.dollar || myPlayer.resources.wheat < b.cost.wheat) {
                showNotification("Kaynak Yetersiz!"); return;
            }
            const mapCopy = JSON.parse(JSON.stringify(gameData.map));
            const tile = mapCopy[selectedTile.y][selectedTile.x];
            tile.structureType = key;
            tile.owner = currentUser.uid;
            tile.hp = 500;

            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                map: mapCopy,
                [`players.${currentUser.uid}.resources.oil`]: increment(-b.cost.oil),
                [`players.${currentUser.uid}.resources.wheat`]: increment(-b.cost.wheat),
                [`players.${currentUser.uid}.resources.dollar`]: increment(-b.cost.dollar)
            });
            selectedTile = null; renderSelectionPanel();
        };

        const trainAction = async (key) => {
             const myPlayer = gameData.players[currentUser.uid];
             const u = UNITS[key];
             if (myPlayer.resources.oil < u.cost.oil || myPlayer.resources.dollar < u.cost.dollar) {
                showNotification("Kaynak Yetersiz!"); return;
            }
            const mapCopy = JSON.parse(JSON.stringify(gameData.map));
            const tile = mapCopy[selectedTile.y][selectedTile.x];
            tile.unit = { type: key, hp: u.hp, maxHp: u.hp, owner: currentUser.uid };

            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                map: mapCopy,
                [`players.${currentUser.uid}.resources.oil`]: increment(-u.cost.oil),
                [`players.${currentUser.uid}.resources.wheat`]: increment(-u.cost.wheat),
                [`players.${currentUser.uid}.resources.dollar`]: increment(-u.cost.dollar)
            });
            selectedTile = null; renderSelectionPanel();
        };

        const offerPact = async (targetId) => {
             const myPlayer = gameData.players[currentUser.uid];
             if (myPlayer.resources.dollar < 500) { showNotification("500$ Gerekli"); return; }
             const expiry = Date.now() + 300000;
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                [`players.${currentUser.uid}.diplomacy.${targetId}`]: expiry,
                [`players.${targetId}.diplomacy.${currentUser.uid}`]: expiry,
                [`players.${currentUser.uid}.resources.dollar`]: increment(-500)
             });
             showNotification("Pakt ƒ∞mzalandƒ±!");
        };

        // Quick Buy Handlers
        el('btn-buy-ammo').onclick = async () => {
             const p = gameData.players[currentUser.uid];
             if (p.resources.wheat < 50 || p.resources.oil < 50) return showNotification("Kaynak Eksik");
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                 [`players.${currentUser.uid}.resources.wheat`]: increment(-50),
                 [`players.${currentUser.uid}.resources.oil`]: increment(-50),
                 [`players.${currentUser.uid}.resources.ammo`]: increment(50)
             });
        };
        el('btn-buy-move').onclick = async () => {
             const p = gameData.players[currentUser.uid];
             if (p.resources.dollar < 50 || p.resources.oil < 50) return showNotification("Kaynak Eksik");
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                 [`players.${currentUser.uid}.resources.dollar`]: increment(-50),
                 [`players.${currentUser.uid}.resources.oil`]: increment(-50),
                 [`players.${currentUser.uid}.resources.move`]: increment(50)
             });
        };

        // Market Handlers
        el('btn-post-offer').onclick = async () => {
            const res = el('market-res').value;
            const amt = parseInt(el('market-amt').value);
            const prc = parseInt(el('market-price').value);
            const p = gameData.players[currentUser.uid];
            if (p.resources[res.toLowerCase()] < amt) return showNotification("Kaynak Yetersiz");

            const offer = { id: Date.now().toString(), seller: currentUser.uid, resource: res, amount: amt, price: prc };
            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                market: arrayUnion(offer),
                [`players.${currentUser.uid}.resources.${res.toLowerCase()}`]: increment(-amt)
            });
            showNotification("ƒ∞lan Eklendi");
        };

        window.buyMarketOffer = async (offer) => {
            const p = gameData.players[currentUser.uid];
            if (p.resources.dollar < offer.price) return showNotification("Para Yetersiz");
            
            const newMarket = gameData.market.filter(o => o.id !== offer.id);
            if (newMarket.length === gameData.market.length) return showNotification("ƒ∞lan bitmi≈ü");

            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `game_${currentGameCode}`), {
                market: newMarket,
                [`players.${currentUser.uid}.resources.dollar`]: increment(-offer.price),
                [`players.${currentUser.uid}.resources.${offer.resource.toLowerCase()}`]: increment(offer.amount),
                [`players.${offer.seller}.resources.dollar`]: increment(offer.price)
            });
        };

    </script>
</body>
</html>
